---
/**
 * Reset Password Page
 *
 * Strona ustawiania nowego hasła po kliknięciu w link z emaila.
 * Waliduje token recovery z URL.
 */

import AuthLayout from "@/layouts/AuthLayout.astro";
import { ResetPasswordForm } from "@/components/auth";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";

// SSR wymagane dla walidacji tokenu
export const prerender = false;

// TODO: Server-side logic po dodaniu backendu
// 1. Walidacja tokenu z URL (?access_token=xxx&type=recovery)
//    - Supabase automatycznie przekierowuje tutaj z emaila
// const { data: { user }, error } = await Astro.locals.supabase.auth.getUser();
//
// 2. Jeśli token nieprawidłowy/wygasły:
// if (error || !user) {
//   // Wyświetl komunikat błędu
// }
//
// 3. Jeśli użytkownik już zalogowany (bez tokenu recovery):
// const isRecoverySession = Astro.url.searchParams.get('type') === 'recovery';
// if (user && !isRecoverySession) {
//   return Astro.redirect('/settings');
// }

const tokenError = Astro.url.searchParams.get("error");
const isTokenValid = !tokenError; // Tymczasowo - zawsze true w MVP

const tokenErrorMessage = tokenError === "invalid_token"
  ? "Link wygasł lub jest nieprawidłowy"
  : tokenError
    ? "Wystąpił błąd. Spróbuj ponownie."
    : undefined;
---

<AuthLayout title="Ustaw nowe hasło - Szybkie Kalorie">
  {!isTokenValid && tokenErrorMessage ? (
    <Card>
      <CardContent className="pt-6 text-center">
        <Alert variant="destructive" className="mb-4">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Błąd</AlertTitle>
          <AlertDescription>{tokenErrorMessage}</AlertDescription>
        </Alert>
        <p class="text-sm text-muted-foreground mb-4">
          Link do resetowania hasła wygasł lub jest nieprawidłowy.
        </p>
        <Button asChild className="w-full">
          <a href="/auth/forgot-password">Poproś o nowy link</a>
        </Button>
      </CardContent>
    </Card>
  ) : (
    <ResetPasswordForm client:load />
  )}
</AuthLayout>
